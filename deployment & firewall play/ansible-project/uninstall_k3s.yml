---
# 1. Limpieza de workers
- name: Desinstalar K3s de los workers
  hosts: k3s_workers
  become: yes
  tasks:
    - name: Ejecutar desinstalación del agente K3s (si existe)
      shell: /usr/local/bin/k3s-agent-uninstall.sh
      args:
        removes: /usr/local/bin/k3s-agent-uninstall.sh # mira si el archivo existe, en cuyo caso ejecuta
      ignore_errors: yes  # continuar aunque falle la ejecución

    - name: Eliminar directorios residuales (limpieza profunda)
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/rancher
        - /var/lib/rancher
        - /usr/local/bin/k3s
        - /usr/local/bin/k3s-agent

# 2. Limpieza del máster
- name: Desinstalar K3s del máster
  hosts: k3s_master
  become: yes
  tasks:
    - name: Ejecutar desinstalación del máster (si existe)
      shell: /usr/local/bin/k3s-uninstall.sh
      args:
        removes: /usr/local/bin/k3s-uninstall.sh
      ignore_errors: yes

    - name: Eliminar directorios residuales (limpieza profunda)
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/rancher
        - /var/lib/rancher
        - /usr/local/bin/k3s
        - /root/.kube  # borramos la configuración de kubectl del usuario root