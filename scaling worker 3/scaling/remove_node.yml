---
- name: Operación de desescalado (quitar nodo y limpiar)
  hosts: k3s_new_worker
  become: yes
  tasks:
    # 1. Quitar el nodo desde el master
    - name: Cordon node (marcar como no programable)
      command: >
        /usr/local/bin/kubectl cordon {{ inventory_hostname }}
      delegate_to: "{{ groups['k3s_master'][0] }}"
      ignore_errors: yes 

    - name: Drain node (vaciar los pods)
      command: >
        /usr/local/bin/kubectl drain {{ inventory_hostname }}
        --ignore-daemonsets
        --delete-emptydir-data
        --force
        --timeout=60s
      delegate_to: "{{ groups['k3s_master'][0] }}"
      ignore_errors: yes

    - name: Delete node (eliminar del clúster)
      command: >
        /usr/local/bin/kubectl delete node {{ inventory_hostname }}
      delegate_to: "{{ groups['k3s_master'][0] }}"
      ignore_errors: yes

    # 2. Limpiar el worker 3
    - name: Comprobar si existe el desinstalador de K3s
      stat:
        path: /usr/local/bin/k3s-agent-uninstall.sh
      register: k3s_uninstall_script

    - name: Desinstalar K3s Agent del nodo
      command: /usr/local/bin/k3s-agent-uninstall.sh
      when: k3s_uninstall_script.stat.exists