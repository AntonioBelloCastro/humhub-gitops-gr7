apiVersion: apps/v1
kind: Deployment
metadata:
  name: humhub
  namespace: humhub
  labels:
    app: humhub
  annotations:
    argocd.argoproj.io/compare-options: IgnoreDetailedDiff=true #ArgoCD que ignore las diferencias menores
    argocd.argoproj.io/sync-options: PreserveResourcesOnDelete=true #Evitar la pérdida accidental de la base de datos si el manifiesto se elimina de YAML se elimina de Git
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: humhub
  template:
    metadata:
      labels:
        app: humhub
    spec:
      #para que coja la credencial (el token)
      imagePullSecrets:
      - name: regcred
      containers:
      - name: humhub
        image: mriedmann/humhub:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
        env:
        # ---------------------------------------------------------
        # ZONA DE CONEXIÓN CON ROL 1 (MYSQL)
        # ---------------------------------------------------------
        
        # HOST DE LA BASE DE DATOS
        # En base/mysql/service.yaml, nos fijamos en metadata: name
        - name: HUMHUB_DB_HOST
          value: "mysql-service"

        # NOMBRE DE LA BASE DE DATOS
        - name: HUMHUB_DB_NAME
          valueFrom:
            secretKeyRef:
              name: humhub-mysql-secret
              key: MYSQL_DATABASE

        # USUARIO DE LA BASE DE DATOS
        - name: HUMHUB_DB_USER
          valueFrom:
            secretKeyRef:
              name: humhub-mysql-secret
              key: MYSQL_USER

        # CONTRASEÑA DE LA BASE DE DATOS
        - name: HUMHUB_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: humhub-mysql-secret
              key: MYSQL_PASSWORD

        # ---------------------------------------------------------
        - name: HUMHUB_TRUSTED_HOSTS
          value: "*"
        - name: HUMHUB_DEBUG
          value: "false"
        - name: HUMHUB_AUTO_INSTALL
          value: "false"

        # ---------------------------------------------------------
        # El volumen para las fotos, archivos adjuntos...
        # ---------------------------------------------------------
        volumeMounts:
        - name: humhub-data 
          mountPath: /var/www/html/uploads #aqui es donde se van a guardar las fotos y demás
        - name: humhub-modules
          mountPath: /var/www/html/protected/modules
        - name: humhub-config
          mountPath: /var/www/html/protected/config

      # Definición de los discos 
      volumes:
      - name: humhub-data
        persistentVolumeClaim:
          claimName: humhub-pv-claim #las fotos y archivos adjuntos se van a guardar en este disco
      - name: humhub-modules
        emptyDir: {} #esto se borra al reiniciar
      - name: humhub-config
        emptyDir: {} #esto se borra al reiniciar tb